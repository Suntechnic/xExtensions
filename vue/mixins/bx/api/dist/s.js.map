{"version":3,"file":"s.js","sources":["../src/api.js"],"sourcesContent":["/**\n * компонент использующий миксин, должен содержать ключ api\n * в ключе api должен быть ключ points содержащий описания эндпонинтов\n * example:\n\napi: {\n    host: \"retail-crm.com\", // может быть указан хост, тогда запрос будет выполняться к нему, если хост задан, sessid не передается\n    protocol: \"https\", // если протокол не задан, то используется https\n    version: \"v1\", // версия api обязательна, но используется только для опередления готовности api\n    points: {\n        tradeinCatalog: {\n            uri: \"/api/v1/tradein/{CodeProject}/\",\n            parameters: {\n                CodeProject: \"[^/]+\"\n            },\n            methods: [\n                \"GET\",\n                \"HEAD\"\n            ]\n        },\n    }\n},\n * \n * пример роутов\n    // группа api версии 1\n    $routes->prefix('api/v1')->group(function (RoutingConfigurator $routes) {\n            $routes->any('subscribe/add', [\\Controllers\\Subscribe::class,'add']);\n        });\n */\n\nexport const MixinBxApi = {\n    data () {\n\t\treturn {\n            apiDebug: false, // можно переопределить для рассширенной отладки\n            apiState: {\n                probe: 0,\n                queryWaitingResponse: 0\n            }\n        }\n    },\n    methods: {\n        getPointUrl (name, data) {\n            if (this.api?.points) {\n                let EndPoint = this.api.points[name];\n\n                if (EndPoint?.uri) {\n                    let Url = EndPoint.uri;\n                    if (data && typeof data == 'object') {\n                        for (let Key in data) {\n                            let Val = data[Key];\n                            let Placer = '{'+Key+'}';\n                            Url = Url.replace(Placer,Val);\n                        }\n                    }\n                    return Url;\n                }\n\n                console.error('x.vue.bx.api','Invalid endpoint: '+name, EndPoint);\n            } else {\n                console.error('x.vue.bx.api','API is not available');\n            }\n        },\n        queryPoint (name, data, callback) {\n            if (this.api?.version && this.api?.points) { // если есть версия (нет версии - значит api не загружен) и точки\n                data = data || {};\n                let EndPoint = this.api.points[name];\n\n                if (!EndPoint) {\n                    console.error('x.vue.bx.api','Invalid endpoint: '+name,this.api.points);\n                    return;\n                }\n\n                let DefaultMethod = EndPoint.methods[0] || 'GET';\n                let Url = this.getPointUrl(name, data);\n\n                if (this.api.host) { // для стаороннего хоста сессию не используем\n                    Url = this.api.host+Url;\n                    if (this.api.protocol) {\n                        Url = this.api.protocol+'://'+Url;\n                    } else {\n                        Url = 'https://'+Url;\n                    }\n                } else if (!data.sessid && BX?.bitrix_sessid) {\n                    data.sessid = BX.bitrix_sessid()\n                }\n\n                let method = BX.ajax['get'];\n                if (DefaultMethod == 'POST') method = BX.ajax['post'];\n\n                if (this.apiDebug) {\n                    console.log('x.vue.bx.api','API query',name,Url,data);\n                }\n\n                this.apiState.queryWaitingResponse++;\n                method(\n                        Url,\n                        data,\n                        (response) => {\n                            this.apiState.queryWaitingResponse--;\n                            if (this.apiDebug) {\n                                console.log('x.vue.bx.api','API response',name,response);\n                            }\n                            callback(response);\n                        }\n                    );\n            } else {\n                let reCall = ()=>{\n                        this.queryPoint(name, data, callback);\n                    };\n                if (this.apiState.probe) {\n                    if (this.apiState.probe == 16) {\n                        console.warn('x.vue.bx.api','Very long waiting for the API to be ready');\n                    }\n                    if (this.apiState.probe > 128) {\n                        console.error('x.vue.bx.api','Very long waiting for the API to be ready. The API has been stopped!');\n                        return;\n                    }\n                    setTimeout(reCall,100*this.apiState.probe);\n                    this.apiState.probe++;\n                } else {\n                    this.apiState.probe = 1;\n                    this.$nextTick(reCall);\n                }\n            }\n        }\n    }\n}\n"],"names":["MixinBxApi","data","apiDebug","apiState","probe","queryWaitingResponse","methods","getPointUrl","name","api","points","EndPoint","uri","Url","Key","Val","Placer","replace","console","error","queryPoint","callback","version","DefaultMethod","host","protocol","sessid","BX","bitrix_sessid","method","ajax","log","response","reCall","warn","setTimeout","$nextTick"],"mappings":"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"}