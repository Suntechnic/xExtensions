{"version":3,"file":"s.js","sources":["../src/api.js"],"sourcesContent":["/**\n * компонент использующий миксин, должен содержать ключ api\n * в ключе api должен быть ключ points содержащий описания эндпонинтов вида:\n * \nuserGet: {\n    uri: \"/api/v1/user/{Id}/\",\n    parameters: {\n        Id: \"[^/]+\"\n    },\n    methods: [\n        \"GET\",\n        \"HEAD\"\n    ]\n},\nuserSet: {\n    uri: \"/api/v1/user/{Id}/\",\n    parameters: {\n        Id: \"[^/]+\"\n    },\n    methods: [\n        \"POST\"\n    ]\n},\n * \n * пример роутов\n    // группа api версии 1\n    $routes->prefix('api/v1')->group(function (RoutingConfigurator $routes) {\n            $routes->any('subscribe/add', [\\Controllers\\Subscribe::class,'add']);\n        });\n */\n\nexport const MixinBxApi = {\n    data () {\n\t\treturn {\n            apiState: {\n                probe: 0,\n                queryWaitingResponse: 0\n            }\n        }\n    },\n    methods: {\n        getPointUrl (name, data) {\n            if (this.api?.points) {\n                let EndPoint = this.api.points[name];\n\n                if (EndPoint?.uri) {\n                    let Url = EndPoint.uri;\n                    if (data && typeof data == 'object') {\n                        for (let Key in data) {\n                            let Val = data[Key];\n                            let Placer = '{'+Key+'}';\n                            Url = Url.replace(Placer,Val);\n                        }\n                    }\n                    return Url;\n                }\n\n                console.error('x.vue.bx.api','Invalid endpoint: '+name, EndPoint);\n            } else {\n                console.error('x.vue.bx.api','API is not available');\n            }\n        },\n        queryPoint (name, data, callback) {\n            if (this.api?.points) {\n                data = data || {};\n                let EndPoint = this.api.points[name];\n                let DefaultMethod = EndPoint.methods[0] || 'GET';\n                let Url = this.getPointUrl(name, data);\n\n                let method = BX.ajax['get'];\n                if (DefaultMethod == 'POST') method = BX.ajax['post'];\n\n                this.apiState.queryWaitingResponse++;\n\n                if (!data.sessid && BX?.bitrix_sessid) {\n                    data.sessid = BX.bitrix_sessid()\n                }\n                method(\n                        Url,\n                        data,\n                        (response) => {\n                            this.apiState.queryWaitingResponse--;\n                            callback(response);\n                        }\n                    );\n            } else {\n                let reCall = ()=>{\n                            this.queryPoint(name, data, callback);\n                        };\n                if (this.apiState.probe) {\n                    if (this.apiState.probe == 16) {\n                        console.warn('x.vue.bx.api','Very long waiting for the API to be ready');\n                    }\n                    if (this.apiState.probe > 128) {\n                        console.error('x.vue.bx.api','Very long waiting for the API to be ready. The API has been stopped!');\n                        return;\n                    }\n                    setTimeout(reCall,100*this.apiState.probe);\n                    this.apiState.probe++;\n                } else {\n                    this.apiState.probe = 1;\n                    this.$nextTick(reCall);\n                }\n            }\n        }\n    }\n}\n"],"names":["MixinBxApi","data","apiState","probe","queryWaitingResponse","methods","getPointUrl","name","api","points","EndPoint","uri","Url","Key","Val","Placer","replace","console","error","queryPoint","callback","DefaultMethod","method","BX","ajax","sessid","bitrix_sessid","response","reCall","warn","setTimeout","$nextTick"],"mappings":"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"}