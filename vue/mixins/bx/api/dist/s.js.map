{"version":3,"file":"s.js","sources":["../src/api.js"],"sourcesContent":["/**\n * компонент использующий миксин, должен содержать ключ api\n * в ключе api должен быть ключ points содержащий описания эндпонинтов\n * example:\n\napi: {\n    host: \"retail-crm.com\", // может быть указан хост, тогда запрос будет выполняться к нему, если хост задан, sessid не передается\n    protocol: \"https\", // если протокол не задан, то используется https\n    version: \"v1\", // версия api обязательна, но используется только для опередления готовности api\n    points: {\n        tradeinCatalog: {\n            uri: \"/api/v1/tradein/{CodeProject}/\",\n            parameters: {\n                CodeProject: \"[^/]+\"\n            },\n            methods: [\n                \"GET\",\n                \"HEAD\"\n            ]\n        },\n    }\n},\n * \n * пример роутов\n    // группа api версии 1\n    $routes->prefix('api/v1')->group(function (RoutingConfigurator $routes) {\n            $routes->any('subscribe/add', [\\Controllers\\Subscribe::class,'add']);\n        });\n */\n\nexport const MixinBxApi = {\n    data () {\n\t\treturn {\n            apiDebug: false, // можно переопределить для рассширенной отладки\n            apiState: {\n                probe: 0,\n                queryWaitingResponse: 0,\n                queries: {}\n            }\n        }\n    },\n    created () {\n        // если есть this.$store\n        if (this.$store) {\n            // проверим есть ли в его состояиии ключ api\n            if (!this.$store.state.api) {\n                // зарегистируем естил нет\n                this.$store.registerModule('api', {\n                    namespaced: true,\n                    state: {\n                        queries: {}\n                    },\n                    getters: {\n                        // получает список имен точек и возращает true если есть активные запросы к ним\n                        // если передан пустой массив - то возращает true если есть вообще активные запросы\n                        hasQueries (state) {\n                            return (names)=>{\n                                //сonsole.log('getter api/hasQueries', names);\n                                if (Array.isArray(names) && names.length > 0) {\n                                    for (let UUID in state.queries) {\n                                        let Query = state.queries[UUID];\n                                        if (names.includes(Query.name)) {\n                                            return true;\n                                        }\n                                    }\n                                    return false;\n                                } else {\n                                    return Object.keys(state.queries).length > 0;\n                                }\n                            }\n                        }\n                    },\n                    mutations: {\n                        addQuery (state, payload) {\n                            state.queries[payload.uuid] = payload.query;\n                        },\n                        removeQuery (state, payload) {\n                            delete state.queries[payload.uuid];\n                        }\n                    }\n                });\n            }\n        }\n    },\n    methods: {\n        getPointUrl (name, data) {\n            if (this.api?.points) {\n                let EndPoint = this.api.points[name];\n\n                if (EndPoint?.uri) {\n                    let Url = EndPoint.uri;\n                    if (data && typeof data == 'object') {\n                        for (let Key in data) {\n                            let Val = data[Key];\n                            let Placer = '{'+Key+'}';\n                            Url = Url.replace(Placer,Val);\n                        }\n                    }\n                    return Url;\n                }\n\n                console.error('x.vue.bx.api','Invalid endpoint: '+name, EndPoint);\n            } else {\n                console.error('x.vue.bx.api','API is not available');\n            }\n        },\n        queryPoint (name, data, callback) {\n            if (this.api?.version && this.api?.points) { // если есть версия (нет версии - значит api не загружен) и точки\n                data = data || {};\n                let EndPoint = this.api.points[name];\n\n                if (!EndPoint) {\n                    console.error('x.vue.bx.api','Invalid endpoint: '+name,this.api.points);\n                    return;\n                }\n\n                let DefaultMethod = EndPoint.methods[0] || 'GET';\n                let Url = this.getPointUrl(name, data);\n\n                if (this.api.host) { // для стаороннего хоста сессию не используем\n                    Url = this.api.host+Url;\n                    if (this.api.protocol) {\n                        Url = this.api.protocol+'://'+Url;\n                    } else {\n                        Url = 'https://'+Url;\n                    }\n                } else if (!data.sessid && BX?.bitrix_sessid) {\n                    data.sessid = BX.bitrix_sessid()\n                }\n\n\n                /**\n                 * В method помещаем функцию BX.ajax.get или BX.ajax.post\n                 * им в дальнешейм будет выполнен запрос\n                 * В DefaultMethod хранится строка с методом запроса 'GET' или 'POST'\n                 */\n                let method = BX.ajax['get'];\n                if (DefaultMethod == 'POST') method = BX.ajax['post'];\n\n\n                if (this.apiDebug) {\n                    console.log('x.vue.bx.api','API query',name,Url,data);\n                }\n\n                /**\n                 * Для метода GET возможно данные уже присуствуют в документе в виде\n                 * <script type=\"application/json\" name=\"name\" href=\"Url\">{...}</script>\n                 */\n                if (DefaultMethod == 'GET') {\n                    let Data = document.querySelector('[name='+name+'][href=\"'+Url+'\"]')?.innerText;\n                    if (Data) {\n                        try {\n                            let response = {status: 'success', data: JSON.parse(Data)};\n                            if (this.apiDebug) {\n                                console.log('x.vue.bx.api','API response from document',name,response);\n                            }\n                            callback(JSON.stringify(response));\n                            return;\n                        } catch (e) {\n                            if (this.apiDebug) console.error('x.vue.bx.api','Error parse API response from document',name,Data,e);\n                        }\n                    }\n                }\n\n                /**\n                 * Регистрируем запрос в this.apiState.queries\n                 * и в this.$store.state.api.queries если есть this.$store\n                 * В качестве ключа используем UUID\n                 */\n                let UUID = 'api-query-'+name+'-'+(new Date()).getTime()+'-'+Math.floor(Math.random()*10000);\n                this.apiState.queries[UUID] = {\n                    name: name,\n                    url: Url,\n                    data: data,\n                    method: DefaultMethod,\n                    timestamp: (new Date()).getTime()\n                };\n\n                // если есть this.$store\n                if (this.$store) {\n                    this.$store.commit('api/addQuery', {\n                        uuid: UUID,\n                        query: this.apiState.queries[UUID]\n                    });\n                }\n\n                /**\n                 * Увеличиваем счетчик ожидающих ответов\n                 */\n                this.apiState.queryWaitingResponse++;\n\n\n                /**\n                 * Выполняем запрос\n                 */\n                method(\n                        Url,\n                        data,\n                        (response) => {\n                            this.apiState.queryWaitingResponse--;\n                            delete this.apiState.queries[UUID];\n\n                            // если есть this.$store\n                            if (this.$store) {\n                                this.$store.commit('api/removeQuery', {\n                                    uuid: UUID\n                                });\n                            }\n\n                            if (this.apiDebug) {\n                                console.log('x.vue.bx.api','API response',name,response);\n                            }\n                            callback(response);\n                        }\n                    );\n            } else {\n                let reCall = ()=>{\n                        this.queryPoint(name, data, callback);\n                    };\n                if (this.apiState.probe) {\n                    if (this.apiState.probe == 16) {\n                        console.warn('x.vue.bx.api','Very long waiting for the API to be ready');\n                    }\n                    if (this.apiState.probe > 128) {\n                        console.error('x.vue.bx.api','Very long waiting for the API to be ready. The API has been stopped!');\n                        return;\n                    }\n                    setTimeout(reCall,100*this.apiState.probe);\n                    this.apiState.probe++;\n                } else {\n                    this.apiState.probe = 1;\n                    this.$nextTick(reCall);\n                }\n            }\n        }\n    }\n}\n"],"names":["MixinBxApi","data","apiDebug","apiState","probe","queryWaitingResponse","queries","created","$store","state","api","registerModule","namespaced","getters","hasQueries","names","Array","isArray","length","UUID","Query","includes","name","Object","keys","mutations","addQuery","payload","uuid","query","removeQuery","methods","getPointUrl","points","EndPoint","uri","Url","Key","Val","Placer","replace","console","error","queryPoint","callback","version","DefaultMethod","host","protocol","sessid","BX","bitrix_sessid","method","ajax","log","Data","document","querySelector","innerText","response","status","JSON","parse","stringify","e","Date","getTime","Math","floor","random","url","timestamp","commit","reCall","warn","setTimeout","$nextTick"],"mappings":"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"}