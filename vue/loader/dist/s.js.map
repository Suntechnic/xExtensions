{"version":3,"file":"s.js","sources":["../src/loader.js"],"sourcesContent":["import {BitrixVue} from 'ui.vue3';\n\n// функция инициализации\nexport const loader = {\n    componentstores: [],\n    store: false,\n    \n    addComponentStore (store)  {\n        for (let i in loader.componentstores) {\n            if (loader.componentstores[i] == store) return;\n        }\n        loader.componentstores.push(store);\n    },\n    \n    addStore (store)  {\n        loader.store = store;\n    },\n\n    cleanNode (node) {\n        node = node || document;\n\n        let Pointer;\n        if (node.getAttribute && (Pointer = node.getAttribute('vueinstance'))) { // если эта нода приложения\n            let pointer = Pointer.split(':');\n            this.delete(pointer[0],pointer[1]);\n        } else { // иначе ищем в этой ноде все ноды приложений\n            let loader = this;\n            node.querySelectorAll('[vueinstance]').forEach((elm) => {\n                loader.cleanNode(elm);\n            });\n        }\n    },\n\n    delete (name,i) {\n        if (BX.X.Vue.Apps[name]?.length) {\n            if (typeof i != 'undefined') {\n                if (BX.X.Vue.Apps[name][i]) {\n                    BX.X.Vue.Apps[name][i].unmount();\n                    //BX.X.Vue.Apps[name][i].destroy();\n                    delete(BX.X.Vue.Apps[name][i]);\n                }\n            } else {\n                for (let i in BX.X.Vue.Apps[name]) {\n                    loader.delete('name',i);\n                }\n            }\n        }\n    },\n\n\n    init: BX.debounce((node) =>  {\n        //console.log('initVue', node);\n        \n        node = node || document\n        let applicationsInRound = []; // список для события\n        node.querySelectorAll('[vue]').forEach((elm) => {\n            \n                let ComponentName = elm.getAttribute('vue');\n                \n                let AppName = 'App'+ComponentName;\n                if (typeof BX.X.Vue.Apps == 'undefined') BX.X.Vue.Apps = {};\n                if (typeof BX.X.Vue.Apps[AppName] == 'undefined') BX.X.Vue.Apps[AppName] = [];\n                \n                // поиск компонента\n                let component = false;\n                for (let i in loader.componentstores) {\n                    let componentstore = loader.componentstores[i];\n                    if (typeof componentstore[ComponentName] == 'object') {\n                        component = componentstore[ComponentName];\n                        break;\n                    }\n                }\n                if (!component \n                        && BX.App?.Vue?.Components \n                        && BX.App.Vue.Components[ComponentName]\n                    ) { // если компонента нет - возможно это компонент приложения\n                    component = BX.App.Vue.Components[ComponentName];\n                }\n                if (!component \n                        && BX.X.Vue.Components \n                        && BX.X.Vue.Components[ComponentName]\n                    ) { // если компонента нет - возможно это собственный компонент\n                    component = BX.X.Vue.Components[ComponentName];\n                }\n                \n                // если компонент нашли\n                if (component) {\n                    let datasetAttrs = '';\n                    for (let name in elm.dataset) {\n                        datasetAttrs = datasetAttrs+' '+name+'=\"'+elm.dataset[name]+'\"';\n                    }\n\n                    let template = '<'+ComponentName+datasetAttrs+'>';\n                    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                    // поддержка слотов\n                    let slotElms = elm.querySelectorAll('[vue-slot]');\n                    slotElms.forEach((slotElm)=>{\n                            let slotName = slotElm.getAttribute('vue-slot');\n                            let slotContent = slotElm.innerHTML;\n                            if (slotName) {\n                                slotContent = '<template v-slot:'+slotName+'>'+slotContent+'</template>';\n                            }\n                            template = template + slotContent;\n                        });\n                    // поддержка слотов\n                    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                    template = template + '</'+ComponentName+'>';\n                    \n                    const components = {};\n                    \n                    components[ComponentName] = component;\n                    const application = BitrixVue.createApp({\n                            name: AppName,\n                            components: components,\n                            template: template\n                        });\n\n                    if (loader.store) application.use(loader.store);\n                    \n                    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                    // поддержка инъекций\n\n                    // предоставляем данные json\n                    let jsonElms = elm.querySelectorAll('[type=\"extension/settings\"][name]');\n                    jsonElms.forEach((jsonElm)=>{\n                            application.provide(jsonElm.getAttribute('name'),JSON.parse(jsonElm.innerText));\n                        });\n                    \n\n                    // предоставляем данные о приложении\n                    application.provide('root',{\n                            'application': application,\n                            'name': AppName,\n                            'index': BX.X.Vue.Apps[AppName].length\n                        });\n                        \n                    // поддержка инъекций\n                    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                \n                    \n                    // удаляем для избежания повторного монтирования\n                    elm.removeAttribute('vue');\n                    if (!elm.getAttribute('vue')) {\n                        application.mount(elm);\n                        applicationsInRound.push(application);\n\n                        elm.setAttribute('vueinstance', AppName+':'+BX.X.Vue.Apps[AppName].length);\n                        BX.X.Vue.Apps[AppName].push(application);\n\n                    } else {\n                        console.error('ERROR premounted!');\n                    }\n                    \n                    \n                    \n                } else console.error('Component '+ComponentName+' not exists');\n            });\n        BX.onCustomEvent('x.vue.loader:inited',{applications: applicationsInRound, node: node});\n    }, 200)\n}\n\n\n// внутреннее событие перестройки DOM\nBX.addCustomEvent('x.vue.loader:initVue', loader.init); //BX.onCustomEvent('x.vue.loader:initVue');\n\n// поддержка композита\nif (window.frameCacheVars !== undefined) {\n    BX.addCustomEvent('onFrameDataReceived', loader.init);\n}\n\n\n// GO\n\n"],"names":["loader","componentstores","store","addComponentStore","i","push","addStore","cleanNode","node","document","Pointer","getAttribute","pointer","split","querySelectorAll","forEach","elm","name","BX","X","Vue","Apps","length","unmount","init","debounce","applicationsInRound","ComponentName","AppName","component","componentstore","App","Components","datasetAttrs","dataset","template","slotElms","slotElm","slotName","slotContent","innerHTML","components","application","BitrixVue","createApp","use","jsonElms","jsonElm","provide","JSON","parse","innerText","removeAttribute","mount","setAttribute","console","error","onCustomEvent","applications","addCustomEvent","window","frameCacheVars","undefined"],"mappings":"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"}