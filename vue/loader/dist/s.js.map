{"version":3,"file":"s.js","sources":["../src/loader.js"],"sourcesContent":["import {BitrixVue} from 'ui.vue3';\n\n/*\n* автозагрузка vue компонентов\n* Загрузчик создает экземпляры приложений и помещает их в списки находящиеся в BX.X.Vue.Apps,\n* именуя ключи как App{ИмяКорневогоКомпонента}\n*\n* Для создания слота монтирования на страниц необходимо создать тег вида:\n* <div vue=\"ИмяКорневогоКомпонента\" data-имяПропса=\"значениеПропса\"></div>\n* например для отбражения кнопок добавления товара 229353 в списки избранного и сравнения:\n* <div vue=\"ListsButton\" data-list=\"compare,favorites\" data-productid=\"229353\"></div>\n*\n* Если необходимо передать в компонент сложные данные, это можно сделать через инъекцию,\n* для этого необходимо данные json поместить во внутрь слота, в токен script c name=КлючИнъекции\n* Например для формы оформления заказа:\n\n    <section class=\"order\" vue=\"Order\">\n        <script type=\"application/json\" name=\"initdata\">\n            {\"ajaxUrl\":\"\\/bitrix\\/components\\/bitrix\\/sale.order.ajax\\/ajax.php\",\"hashBasket\":\"fda088cce0595233895f37519d3d68c5\"}\n        </script>\n    </section>\n\n*\n* Данные будут доступны в компоненте, в инъекции с ключом name.\n* В примере выше:\n\n    inject: ['initdata'],\n    created () {\n            // переносим инициализационные данные\n            this.hashBasket = this.initdata.hashBasket;\n            this.arResult = this.initdata.arResult;\n        },\n\n*\n* Нужно иметь ввиду что данный ключ не может быть root - такой ключ зарезервирован для инхъекции данных о корневом приложении\n*\n* Елси какие-то участки html-кода подгружены после события BX.ready, например по ajax,\n* или созданы другим образом и содержат компоненты которые нужно инициализировать,\n* то после их добавления необходимо вызвать событие x.vue.loader:initVue:\n\n    BX.onCustomEvent('x.vue.loader:initVue');\n\n* \n*/\n\n// функция инициализации\nexport const loader = {\n    componentstores: [],\n    \n    addComponentStore (store)  {\n        loader.componentstores.push(store);\n    },\n    \n    init (node)  {\n        console.log('initVue', node);\n        \n        node = node || document\n        node.querySelectorAll('[vue]').forEach((elm) => {\n            \n                let ComponentName = elm.getAttribute('vue');\n                \n                let AppName = 'App'+ComponentName;\n                if (typeof BX.X.Vue.Apps == 'undefined') BX.X.Vue.Apps = {};\n                if (typeof BX.X.Vue.Apps[AppName] == 'undefined') BX.X.Vue.Apps[AppName] = [];\n                \n                // поиск компонента\n                let component = false;\n                for (let i in loader.componentstores) {\n                    let componentstore = this.componentstores[i];\n                    if (typeof componentstore[ComponentName] == 'object') {\n                        component = componentstore[ComponentName];\n                        break;\n                    }\n                }\n                if (!component && BX.X.Vue.Components) { // если компонента нет - возможно это собственный компонент\n                    component = BX.X.Vue.Components[ComponentName];\n                }\n                \n                // если компонент нашли\n                if (component) {\n                    let datasetAttrs = '';\n                    for (let name in elm.dataset) {\n                        datasetAttrs = datasetAttrs+' '+name+'=\"'+elm.dataset[name]+'\"';\n                    }\n                    let template = '<'+ComponentName+datasetAttrs+'/>';\n                    \n                    const components = {};\n                    \n                    components[ComponentName] = component;\n                    const application = BitrixVue.createApp({\n                            name: AppName,\n                            components: components,\n                            template: template\n                        });\n                    \n                    //application.use(store);\n                    \n                    // предоставляем данные json\n                    let jsonElms = elm.querySelectorAll('[type=\"extension/settings\"][name]');\n                    jsonElms.forEach((jsonElm)=>{\n                            application.provide(jsonElm.getAttribute('name'),JSON.parse(jsonElm.innerText));\n                        });\n                    \n                    // предоставляем данные о приложении\n                    application.provide('root',{\n                            'application': application,\n                            'name': AppName,\n                            'index': BX.X.Vue.Apps[AppName].length\n                        });\n                \n                    \n                    // удаляем для избежания повторного монтирования\n                    elm.removeAttribute('vue');\n                    if (!elm.getAttribute('vue')) {\n                        application.mount(elm);\n                        BX.X.Vue.Apps[AppName].push(application);\n                    } else {\n                        console.error('ERROR premounted!');\n                    }\n                    \n                    \n                    \n                } else console.error('Component '+ComponentName+' not exists');\n            })\n    }\n}\n\n\n// внутреннее событие перестройки DOM\nBX.addCustomEvent('x.vue.loader:initVue', loader.init); //BX.onCustomEvent('x.vue.loader:initVue');\n\n// поддержка композита\nif (window.frameCacheVars !== undefined) {\n    BX.addCustomEvent('onFrameDataReceived', loader.init);\n}\n\n"],"names":["loader","componentstores","addComponentStore","store","push","init","node","console","log","document","querySelectorAll","forEach","elm","ComponentName","getAttribute","AppName","BX","X","Vue","Apps","component","i","componentstore","Components","datasetAttrs","name","dataset","template","components","application","BitrixVue","createApp","jsonElms","jsonElm","provide","JSON","parse","innerText","length","removeAttribute","mount","error","addCustomEvent","window","frameCacheVars","undefined"],"mappings":"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"}